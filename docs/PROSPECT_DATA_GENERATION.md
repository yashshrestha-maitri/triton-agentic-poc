# Prospect Dashboard Data Generation System

## Overview

The system now automatically generates and stores sample dashboard data for every generated template. When templates are created via the Celery workflow, the system:

1. **Generates templates** â†’ Stores in `dashboard_templates` table
2. **Creates/finds demo prospect** â†’ One per client in `prospects` table
3. **Generates widget data** â†’ Synthetic sample data for each widget
4. **Stores in database** â†’ `prospect_dashboard_data` table with widget values

---

## Architecture

### Database Tables

```
clients
  â”œâ”€â”€ dashboard_templates (template structure)
  â”œâ”€â”€ prospects (viewers of dashboards)
  â”‚     â””â”€â”€ prospect_dashboard_data (actual widget values)
  â””â”€â”€ generation_jobs (async job tracking)
```

### Data Flow

```
POST /triton/clients/{id}/generate-templates
         â†“
   [Celery Worker]
         â†“
   Generate 7 Templates
         â†“
   Save to dashboard_templates
         â†“
   Get/Create Demo Prospect
         â†“
   For each template:
     - Generate synthetic widget data
     - Store in prospect_dashboard_data
         â†“
   Job Status: completed
```

---

## What Gets Generated

### Template Structure (dashboard_templates)
```json
{
  "id": "template-uuid",
  "name": "Executive ROI Dashboard",
  "category": "roi-focused",
  "widgets": [
    {
      "id": "w_roi_headline",
      "type": "kpi-card",
      "title": "24-Month ROI",
      "position": {"row": 1, "col": 1, "rowSpan": 2, "colSpan": 3},
      "config": {"format": "percentage", "trend": true}
    }
  ]
}
```

### Widget Data (prospect_dashboard_data.dashboard_data)
```json
{
  "w_roi_headline": {
    "value": 187.5,
    "display": "187.5%",
    "timestamp": "2025-11-28T12:00:00Z",
    "trend": {
      "value": 12.3,
      "direction": "up",
      "display": "+12.3%"
    }
  },
  "w_total_savings": {
    "value": 245000,
    "display": "$245,000",
    "timestamp": "2025-11-28T12:00:00Z"
  }
}
```

---

## Key Components

### 1. SyntheticDataGenerator
**Location:** `core/services/data_generator.py`

Generates realistic sample data based on widget type:

- **KPI Cards** â†’ Single values (numbers, currency, percentages)
- **Line Charts** â†’ Time series data with 12 data points
- **Bar Charts** â†’ Categorical data with 5 categories
- **Pie Charts** â†’ Percentage distributions
- **Waterfall Charts** â†’ Cumulative change analysis
- **Tables** â†’ Tabular data with rows and columns

### 2. ProspectService
**Location:** `core/services/prospect_service.py`

Manages prospects and demo prospect creation:

- `get_or_create_demo_prospect()` â†’ Creates one demo prospect per client
- Demo prospects have email: `demo@triton-agentic.local`
- Auto-generated with `is_demo: true` metadata

### 3. Modified Celery Task
**Location:** `tasks/template_generation.py` (Step 5, lines 260-332)

After template generation:
1. Gets/creates demo prospect
2. Generates data for each template
3. Stores in `prospect_dashboard_data` table
4. Logs success/failures

---

## API Endpoints

### Generate Data Manually
```bash
POST /prospect-data/generate
{
  "template_id": "template-uuid",
  "prospect_id": "prospect-uuid",
  "regenerate": false
}
```

### Get Prospect's Dashboard Data
```bash
GET /prospect-data/{prospect_id}?template_id={template-uuid}&status_filter=ready
```

### Get Specific Template Data for Prospect
```bash
GET /prospect-data/{prospect_id}/{template_id}
```

### Delete Dashboard Data
```bash
DELETE /prospect-data/{prospect_id}/{template_id}
```

---

## Testing the System

### Step 1: Generate Templates (Creates Data Automatically)

```bash
# Submit job via Mare-API
curl -X POST "http://localhost:16000/v1/triton/clients/{client_id}/generate-templates" \
  -H "Content-Type: application/json"

# Get job status
curl "http://localhost:16000/v1/triton/jobs/{job_id}"

# Wait for status: "completed"
```

### Step 2: Verify Data Was Generated

```bash
# List all prospects for client
curl "http://localhost:8000/clients/{client_id}/prospects"

# Get demo prospect ID from response
DEMO_PROSPECT_ID="..."

# Get all dashboard data for demo prospect
curl "http://localhost:8000/prospect-data/{DEMO_PROSPECT_ID}"
```

### Step 3: Inspect Widget Data

```python
import requests

# Get data
response = requests.get(f"http://localhost:8000/prospect-data/{prospect_id}")
data = response.json()

# Check generated data
for record in data['prospect_data']:
    print(f"\nTemplate: {record['template_id']}")
    print(f"Status: {record['status']}")
    print(f"Generated by: {record['generated_by']}")
    print(f"Widget data count: {len(record['dashboard_data'])}")

    # Show sample widget data
    for widget_id, widget_data in record['dashboard_data'].items():
        print(f"  {widget_id}: {widget_data}")
```

### Step 4: Manually Generate Data for Specific Prospect

```bash
# Create a real prospect
curl -X POST "http://localhost:8000/clients/{client_id}/prospects" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "John Smith",
    "organization": "Acme Health Plan",
    "email": "john.smith@acme.com"
  }'

# Generate data for this prospect
curl -X POST "http://localhost:8000/prospect-data/generate" \
  -H "Content-Type: application/json" \
  -d '{
    "template_id": "template-uuid",
    "prospect_id": "john-prospect-uuid",
    "regenerate": false
  }'
```

---

## Database Queries

### Check Demo Prospects

```sql
SELECT id, client_id, name, email, meta_data
FROM prospects
WHERE email = 'demo@triton-agentic.local';
```

### Check Generated Data Count

```sql
SELECT
    p.name as prospect_name,
    dt.name as template_name,
    pdd.status,
    pdd.generated_by,
    jsonb_object_keys(pdd.dashboard_data) as widget_count,
    pdd.generated_at
FROM prospect_dashboard_data pdd
JOIN prospects p ON pdd.prospect_id = p.id
JOIN dashboard_templates dt ON pdd.template_id = dt.id
ORDER BY pdd.generated_at DESC;
```

### Check Widget Data for Specific Template

```sql
SELECT
    dashboard_data,
    validation_result,
    generation_duration_ms,
    status
FROM prospect_dashboard_data
WHERE prospect_id = 'prospect-uuid'
  AND template_id = 'template-uuid';
```

### Count Data by Status

```sql
SELECT
    status,
    COUNT(*) as count
FROM prospect_dashboard_data
GROUP BY status;
```

---

## Widget Data Examples

### KPI Card with Trend
```json
{
  "value": 187.5,
  "display": "187.5%",
  "timestamp": "2025-11-28T12:00:00Z",
  "trend": {
    "value": 12.3,
    "direction": "up",
    "display": "+12.3%"
  },
  "target": 200,
  "progress": 93.75
}
```

### Line Chart (Time Series)
```json
{
  "labels": ["2024-01", "2024-02", "2024-03", ...],
  "series": [
    {
      "name": "Total Savings",
      "data": [1200, 1350, 1450, 1600, ...]
    }
  ],
  "timestamp": "2025-11-28T12:00:00Z"
}
```

### Bar Chart (Categories)
```json
{
  "categories": ["Category A", "Category B", "Category C"],
  "series": [
    {
      "name": "Value",
      "data": [2500, 3200, 1800]
    }
  ],
  "timestamp": "2025-11-28T12:00:00Z"
}
```

---

## Configuration

### Data Generation Options

**In `core/services/data_generator.py`:**

```python
# Initialize with seed for reproducible data
generator = SyntheticDataGenerator(seed=42)

# Generate data
dashboard_data = generator.generate_dashboard_data(widgets)
```

### Customization

**Widget-specific generation logic:**
- Edit methods in `SyntheticDataGenerator` class
- Add new widget types as needed
- Adjust value ranges and distributions

---

## Production Considerations

### Current Implementation (Phase 1)
âœ… Synthetic data generation
âœ… Automatic data creation with templates
âœ… Demo prospect per client
âœ… API endpoints for manual generation

### Future Enhancements (Phase 2+)

1. **AI-Generated Data** - Use LLM to generate contextually realistic data
2. **Real Data Integration** - Execute SQL from data_requirements against warehouse
3. **Data Refresh** - Periodic regeneration with updated values
4. **Custom Prospects** - Link templates to specific prospects during generation
5. **Data Validation** - Validate generated data against data schemas
6. **Caching** - Cache generated data for performance

---

## Troubleshooting

### No Data Generated

**Check:**
1. Templates were saved successfully
2. Demo prospect was created (check `prospects` table)
3. Worker logs for errors (`docker logs triton-worker`)
4. Data generation didn't fail silently

**Fix:**
```bash
# Check worker logs
docker logs triton-worker --tail 100 | grep -i "prospect data"

# Manually trigger generation
curl -X POST "http://localhost:8000/prospect-data/generate" \
  -H "Content-Type: application/json" \
  -d '{"template_id": "...", "prospect_id": "..."}'
```

### Data Has Wrong Format

**Check:**
- Widget type in template
- Data generator logic for that type
- Widget config fields

**Fix:**
- Update `SyntheticDataGenerator._generate_XXX_data()` method
- Restart worker: `docker-compose restart worker`

### Duplicate Data Errors

**Error:** `409 Conflict - Data already exists`

**Fix:**
- Set `regenerate: true` in request
- Or delete existing data first

---

## Summary

âœ… **Automated:** Data generated automatically during template creation
âœ… **Flexible:** Manual generation via API endpoints
âœ… **Realistic:** Type-appropriate sample data for each widget
âœ… **Scalable:** One demo prospect per client, unlimited real prospects
âœ… **Extensible:** Easy to add new widget types or data sources

The system is now ready to generate and store dashboard data! ðŸŽ‰
